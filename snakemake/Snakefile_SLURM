
configfile: "config.json"

base_path = config["BASE_PATH"]
base_name = config["BASE_NAME"]

rule add_parameters_and_normalize:
    input:
        expand("{base_path}/{base_name}.laz", base_path=base_path, base_name=base_name)
    output:
        expand("{base_path}/output/{base_name}_normalized.las", base_path=base_path, base_name=base_name)
    resources:
        runtime = 5, # minutes
        cpus_per_task = 1,
        mem_mb = 20000,
    script:
        "../workflow/01/01_add_parameters_and_normalize.py"

rule georeference:
    input:
        rules.add_parameters_and_normalize.output
    output:
        expand("{base_path}/output/{base_name}_georef.las", base_path=base_path, base_name=base_name)
    resources:
        runtime = 5, # minutes
        cpus_per_task = 1,
        mem_mb = 20000,
    script:
        "../workflow/02/02_georeference.py"

rule spatial_resample:
    input:
        rules.georeference.output
    output:
        expand("{base_path}/output/{base_name}_resampled.las", base_path=base_path, base_name=base_name)
    script:
        "../workflow/03/03_spatial_resample.py"

rule clipping_trees:
    input:
        rules.georeference.output
    output:
        directory(expand("{base_path}/output/single_trees/", base_path=base_path))
    script:
        "../workflow/04/04_clipping_trees.py"

rule normalize_to_ground:
    input:
        rules.clipping_trees.output
    output:
        directory(expand("{base_path}/output/single_trees_normalized_to_ground", base_path=base_path))
    resources:
        runtime = 5, # minutes
        cpus_per_task = 1,
        mem_mb = 20000,
    script:
        "../workflow/05/05_normalize_to_ground.py"

rule fine_segmentation:
    input:
        rules.normalize_to_ground.output
    output:
        output_dir = directory(expand("{base_path}/output/fine_segmentation", base_path=base_path)),
        output_dir_noise = directory(expand("{base_path}/output/fine_segmentation_noise", base_path=base_path))
    resources:
        runtime = 5, # minutes
        cpus_per_task = 1,
        mem_mb = 20000,
    script:
        "../workflow/06/06_fine_segmentation.py"
